var __extends=this&&this.__extends||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p];function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};var Myna;(function(Myna){function _initialize(text){_input=text;_stack=[new AstNode(null)]}Myna._initialize=_initialize;function match(r,s){_initialize(s);return r.match(0)}Myna.match=match;function parse(r,s){_initialize(s);var end=r.parse(0);if(_stack.length!=1)throw Exceptions.InternalStackError;var root=_stack[0];root.end=end;return root}Myna.parse=parse;(function(Exceptions){Exceptions[Exceptions["MissingOverride"]=0]="MissingOverride";Exceptions[Exceptions["InternalStackError"]=1]="InternalStackError";Exceptions[Exceptions["InfiniteLoop"]=2]="InfiniteLoop";Exceptions[Exceptions["InvalidRuleType"]=3]="InvalidRuleType";Exceptions[Exceptions["CloneInvalidType"]=4]="CloneInvalidType";Exceptions[Exceptions["RangeRequiresChars"]=5]="RangeRequiresChars";Exceptions[Exceptions["TokenIncludedTwiceInLookup"]=6]="TokenIncludedTwiceInLookup"})(Myna.Exceptions||(Myna.Exceptions={}));var Exceptions=Myna.Exceptions;Myna.grammars={};Myna.rules={};var _nextId=0;function genId(){return _nextId++}var failed=-1;var _input="";var _stack;function RuleTypeToRule(rule){if(rule instanceof Rule)return rule;if(typeof rule==="string")return text(rule);if(typeof rule==="boolean")return rule?Myna.truePredicate:Myna.falsePredicate;throw Exceptions.InvalidRuleType}Myna.RuleTypeToRule=RuleTypeToRule;var AstNode=function(){function AstNode(rule,start,end){if(start===void 0){start=0}if(end===void 0){end=failed}this.rule=rule;this.start=start;this.end=end;this.children=null}Object.defineProperty(AstNode.prototype,"contents",{get:function(){return _input.slice(this.start,this.end)},enumerable:true,configurable:true});return AstNode}();Myna.AstNode=AstNode;var Rule=function(){function Rule(rules){this.rules=rules;this.name="";this.id=genId();this.type="";this._createAstNode=false}Rule.prototype.parseImplementation=function(index){throw Exceptions.MissingOverride};Rule.prototype.match=function(index){if(index<0||index>_input.length)return false;return this.parseImplementation(index)!=failed};Rule.prototype.parse=function(index){if(index<0||index>_input.length)return failed;if(!this._createAstNode){return this.parseImplementation(index)}else{var node=new AstNode(this,index);_stack.push(node);var end_1=this.parseImplementation(index);var child=_stack.pop();if(child!=node)throw Exceptions.InternalStackError;if(end_1===failed)return failed;child.end=end_1;if(_stack.length===0)throw Exceptions.InternalStackError;var parent_1=_stack[_stack.length-1];if(parent_1.children==null)parent_1.children=new Array;parent_1.children.push(child);return end_1}};Rule.prototype.setType=function(typeName){this.type=typeName;return this};Rule.prototype.setName=function(name){this.name=name;return this};Object.defineProperty(Rule.prototype,"definition",{get:function(){return"_"+this.type+"_"},enumerable:true,configurable:true});Object.defineProperty(Rule.prototype,"nameOrDefinition",{get:function(){return this.name?this.name:this.definition},enumerable:true,configurable:true});Rule.prototype.toString=function(){return this.name+"\t<- "+this.definition};Object.defineProperty(Rule.prototype,"firstChild",{get:function(){return this.rules[0]},enumerable:true,configurable:true});Rule.prototype.cloneImplementation=function(){throw Exceptions.MissingOverride};Object.defineProperty(Rule.prototype,"copy",{get:function(){var r=this.cloneImplementation();if(typeof r!==typeof this)throw Exceptions.CloneInvalidType;r.name=this.name;r.type=this.type;r._createAstNode=this._createAstNode;return r},enumerable:true,configurable:true});Object.defineProperty(Rule.prototype,"ast",{get:function(){var r=this.copy;r._createAstNode=true;return r},enumerable:true,configurable:true});Object.defineProperty(Rule.prototype,"opt",{get:function(){return opt(this)},enumerable:true,configurable:true});Object.defineProperty(Rule.prototype,"star",{get:function(){return star(this)},enumerable:true,configurable:true});Object.defineProperty(Rule.prototype,"plus",{get:function(){return plus(this)},enumerable:true,configurable:true});Object.defineProperty(Rule.prototype,"not",{get:function(){return not(this)},enumerable:true,configurable:true});Object.defineProperty(Rule.prototype,"advance",{get:function(){return this.then(Myna.advance)},enumerable:true,configurable:true});Object.defineProperty(Rule.prototype,"ws",{get:function(){return this.then(Myna.ws)},enumerable:true,configurable:true});Object.defineProperty(Rule.prototype,"all",{get:function(){return this.then(Myna.all)},enumerable:true,configurable:true});Object.defineProperty(Rule.prototype,"end",{get:function(){return this.then(Myna.end)},enumerable:true,configurable:true});Rule.prototype.then=function(r){return seq(this,r)};Rule.prototype.thenAt=function(r){return this.then(at(r))};Rule.prototype.thenNot=function(r){return this.then(not(r))};Rule.prototype.or=function(r){return choice(this,r)};Rule.prototype.until=function(r){return repeatWhileNot(this,r)};Rule.prototype.untilPast=function(r){return repeatUntilPast(this,r)};Rule.prototype.repeat=function(count){return repeat(this,count)};Rule.prototype.bounded=function(min,max){return bounded(this,min,max)};Rule.prototype.delimited=function(delimiter){return delimited(this,delimiter)};return Rule}();Myna.Rule=Rule;var Sequence=function(_super){__extends(Sequence,_super);function Sequence(rules){_super.call(this,rules);this.type="sequence"}Sequence.prototype.parseImplementation=function(index){for(var _i=0,_a=this.rules;_i<_a.length;_i++){var r=_a[_i];index=r.parse(index);if(index===failed)return index}return index};Object.defineProperty(Sequence.prototype,"definition",{get:function(){return"("+this.rules.map(function(r){return r.nameOrDefinition}).join(" ")+")"},enumerable:true,configurable:true});Sequence.prototype.cloneImplementation=function(){return new Sequence(this.rules)};return Sequence}(Rule);Myna.Sequence=Sequence;var Choice=function(_super){__extends(Choice,_super);function Choice(rules){_super.call(this,rules);this.type="choice"}Choice.prototype.parseImplementation=function(index){for(var _i=0,_a=this.rules;_i<_a.length;_i++){var r=_a[_i];var result=r.parse(index);if(result===failed)continue;return result}return failed};Choice.prototype.match=function(index){for(var _i=0,_a=this.rules;_i<_a.length;_i++){var r=_a[_i];if(r.match(index))return true}return false};Object.defineProperty(Choice.prototype,"definition",{get:function(){return"("+this.rules.map(function(r){return r.nameOrDefinition}).join(" / ")+")"},enumerable:true,configurable:true});Choice.prototype.cloneImplementation=function(){return new Choice(this.rules)};return Choice}(Rule);Myna.Choice=Choice;var BoundedRule=function(_super){__extends(BoundedRule,_super);function BoundedRule(rule,min,max){if(min===void 0){min=0}if(max===void 0){max=-1}_super.call(this,[rule]);this.min=min;this.max=max;this.type="bounded"}BoundedRule.prototype.parseImplementation=function(index){var result=index;for(var i=0;this.max<0||i<this.max;++i){var tmp=this.firstChild.parse(result);if(tmp===failed)return i>=this.min?result:failed;if(this.max<0)if(result===tmp)throw Exceptions.MissingOverride;if(i>_input.length)return failed;result=tmp}return result};Object.defineProperty(BoundedRule.prototype,"definition",{get:function(){return this.firstChild.nameOrDefinition+"{"+this.min+","+(this.max>=0?this.max:"*")+"}"},enumerable:true,configurable:true});BoundedRule.prototype.cloneImplementation=function(){return new BoundedRule(this.firstChild,this.min,this.max)};return BoundedRule}(Rule);Myna.BoundedRule=BoundedRule;var Advance=function(_super){__extends(Advance,_super);function Advance(){_super.call(this,[]);this.type="advance"}Advance.prototype.parseImplementation=function(index){return index<_input.length?index+1:failed};Object.defineProperty(Advance.prototype,"definition",{get:function(){return"."},enumerable:true,configurable:true});Advance.prototype.cloneImplementation=function(){return new Advance};return Advance}(Rule);Myna.Advance=Advance;var Lookup=function(_super){__extends(Lookup,_super);function Lookup(lookup,onDefault){_super.call(this,[]);this.lookup=lookup;this.onDefault=onDefault;this.type="lookup"}Lookup.prototype.parseImplementation=function(index){if(index>=_input.length)return failed;var tkn=_input[index];var r=this.lookup[tkn];if(r!==undefined)return r.parse(index);return this.onDefault.parse(index)};Object.defineProperty(Lookup.prototype,"definition",{get:function(){return this.lookup},enumerable:true,configurable:true});Lookup.prototype.cloneImplementation=function(){return new Lookup(this.lookup,this.onDefault)};return Lookup}(Rule);Myna.Lookup=Lookup;var Text=function(_super){__extends(Text,_super);function Text(text){_super.call(this,[]);this.text=text;this.type="text"}Text.prototype.parseImplementation=function(index){if(index>_input.length-this.text.length)return failed;for(var i=0;i<this.text.length;++i)if(_input[index+i]!==this.text[i])return failed;return index+this.text.length};Object.defineProperty(Text.prototype,"definition",{get:function(){return"'"+this.text+"'"},enumerable:true,configurable:true});Text.prototype.cloneImplementation=function(){return new Text(this.text)};return Text}(Rule);Myna.Text=Text;var Delay=function(_super){__extends(Delay,_super);function Delay(fn){_super.call(this,[]);this.fn=fn;this.type="delay"}Delay.prototype.parseImplementation=function(index){return this.fn().parse(index)};Object.defineProperty(Delay.prototype,"definition",{get:function(){return this.fn().definition},enumerable:true,configurable:true});Delay.prototype.cloneImplementation=function(){return new Delay(this.fn)};return Delay}(Rule);Myna.Delay=Delay;var PredicateRule=function(_super){__extends(PredicateRule,_super);function PredicateRule(){_super.apply(this,arguments)}PredicateRule.prototype.parse=function(index){if(!this.match(index))return failed;return index};return PredicateRule}(Rule);Myna.PredicateRule=PredicateRule;var Not=function(_super){__extends(Not,_super);function Not(rule){_super.call(this,[rule]);this.type="not"}Not.prototype.match=function(index){return!this.firstChild.match(index)};Object.defineProperty(Not.prototype,"definition",{get:function(){return"!"+this.firstChild.nameOrDefinition},enumerable:true,configurable:true});Not.prototype.cloneImplementation=function(){return new Not(this.firstChild)};return Not}(PredicateRule);Myna.Not=Not;var At=function(_super){__extends(At,_super);function At(rule){_super.call(this,[rule]);this.type="at"}At.prototype.match=function(index){return this.firstChild.match(index)};Object.defineProperty(At.prototype,"definition",{get:function(){return"&"+this.firstChild.nameOrDefinition},enumerable:true,configurable:true});At.prototype.cloneImplementation=function(){return new At(this.firstChild)};return At}(PredicateRule);Myna.At=At;var Predicate=function(_super){__extends(Predicate,_super);function Predicate(fn){_super.call(this,[]);this.fn=fn;this.type="predicate"}Predicate.prototype.match=function(index){return this.fn(index)};Predicate.prototype.cloneImplementation=function(){return new Predicate(this.fn)};return Predicate}(PredicateRule);Myna.Predicate=Predicate;function text(text){return new Text(text)}Myna.text=text;function seq(){var rules=[];for(var _i=0;_i<arguments.length;_i++){rules[_i-0]=arguments[_i]}return new Sequence(rules.map(RuleTypeToRule))}Myna.seq=seq;function choice(){var rules=[];for(var _i=0;_i<arguments.length;_i++){rules[_i-0]=arguments[_i]}return new Choice(rules.map(RuleTypeToRule))}Myna.choice=choice;function delay(fxn){return new Delay(function(){return RuleTypeToRule(fxn())})}Myna.delay=delay;function not(rule){return new Not(RuleTypeToRule(rule))}Myna.not=not;function bounded(rule,min,max){if(min===void 0){min=0}if(max===void 0){max=-1}return new BoundedRule(RuleTypeToRule(rule),min,max)}Myna.bounded=bounded;function star(rule){return bounded(rule).setType("star")}Myna.star=star;function plus(rule){return bounded(rule,1).setType("plus")}Myna.plus=plus;function opt(rule){return bounded(rule,0,1).setType("opt")}Myna.opt=opt;function repeat(rule,count){return bounded(rule,count,count).setType("repeat")}Myna.repeat=repeat;function at(rule){return new At(RuleTypeToRule(rule))}Myna.at=at;function lookup(tokens,rule,onDefault){if(onDefault===void 0){onDefault=false}var d={};var r=RuleTypeToRule(rule);for(var _i=0,tokens_1=tokens;_i<tokens_1.length;_i++){var t=tokens_1[_i];if(t in d)throw Exceptions.TokenIncludedTwiceInLookup;d[t]=r}return new Lookup(d,RuleTypeToRule(onDefault))}Myna.lookup=lookup;function atChar(chars){return lookup(chars.split(""),Myna.truePredicate)}Myna.atChar=atChar;function notAtChar(chars){return lookup(chars.split(""),Myna.falsePredicate,Myna.truePredicate)}Myna.notAtChar=notAtChar;function char(chars){return lookup(chars.split(""),Myna.advance)}Myna.char=char;function charExcept(chars){return lookup(chars.split(""),Myna.falsePredicate,Myna.advance)}Myna.charExcept=charExcept;function inRange(min,max,rule,onDefault){if(onDefault===void 0){onDefault=false}if(min.length!=1||max.length!=1)throw Exceptions.RangeRequiresChars;var minChar=min.charCodeAt(0);var maxChar=max.charCodeAt(0);var tokens=[];for(var x=minChar;x<=maxChar;++x)tokens.push(String.fromCharCode(x));return lookup(tokens,rule,onDefault)}Myna.inRange=inRange;function range(min,max){return inRange(min,max,Myna.advance)}Myna.range=range;function exceptRange(min,max){return inRange(min,max,Myna.falsePredicate,Myna.advance)}Myna.exceptRange=exceptRange;function delimited(rule,delimiter){return opt(seq(rule,star(seq(delimiter,rule)))).setType("delimitedList")}Myna.delimited=delimited;function except(condition,rule){return seq(not(condition),rule).setType("except")}Myna.except=except;function repeatWhileNot(body,condition){return star(except(condition,body)).setType("whileNot")}Myna.repeatWhileNot=repeatWhileNot;function repeatUntilPast(body,condition){return seq(repeatWhileNot(body,condition),condition).setType("repeatUntilPast")}Myna.repeatUntilPast=repeatUntilPast;function advanceWhileNot(rule){return not(rule).advance.star.setType("advanceWhileNot")}Myna.advanceWhileNot=advanceWhileNot;function advanceUntilPast(rule){return seq(advanceWhileNot(rule),rule).setType("advanceUntilPast")}Myna.advanceUntilPast=advanceUntilPast;function predicate(fn){return new Predicate(fn)}Myna.predicate=predicate;function action(fn){return predicate(function(index){fn(index);return true}).setType("action")}Myna.action=action;function err(ex){return action(function(p){ex.location=p;throw ex}).setType("err")}Myna.err=err;function log(msg){if(msg===void 0){msg=""}return action(function(p){console.log(msg)}).setType("log")}Myna.log=log;function assert(rule){return choice(rule,err({rule:rule,type:"assert"})).setType("assert")}Myna.assert=assert;function guardedSeq(condition){var rules=[];for(var _i=1;_i<arguments.length;_i++){rules[_i-1]=arguments[_i]}return seq(condition,seq.apply(void 0,rules.map(function(r){return assert(r)}))).setType("guardedSeq")}Myna.guardedSeq=guardedSeq;function doubleQuoted(rule){return guardedSeq('"',rule,'"').setType("doubleQuoted")}Myna.doubleQuoted=doubleQuoted;function singleQuoted(rule){return guardedSeq("'",rule,"'").setType("singleQuoted")}Myna.singleQuoted=singleQuoted;function parenthesized(rule){return guardedSeq("(",Myna.ws,rule,Myna.ws,")").setType("parenthesized")}Myna.parenthesized=parenthesized;function braced(rule){return guardedSeq("{",Myna.ws,rule,Myna.ws,"}").setType("braced")}Myna.braced=braced;function bracketed(rule){return guardedSeq("[",Myna.ws,rule,Myna.ws,"]").setType("bracketed")}Myna.bracketed=bracketed;function tagged(rule){return guardedSeq("<",Myna.ws,rule,Myna.ws,">").setType("tagged")}Myna.tagged=tagged;function keyword(text){return seq(text,not(Myna.identifierNext)).setType("keyword")}Myna.keyword=keyword;function keywords(){var words=[];for(var _i=0;_i<arguments.length;_i++){words[_i-0]=arguments[_i]}return choice.apply(void 0,words.map(keyword))}Myna.keywords=keywords;Myna.truePredicate=predicate(function(index){return true});Myna.falsePredicate=predicate(function(index){return false});Myna.end=predicate(function(index){return index>=_input.length});Myna.notEnd=predicate(function(index){return index<_input.length});Myna.advance=new Advance;Myna.all=Myna.advance.star;Myna.letterLower=range("a","z");Myna.letterUpper=range("A","Z");Myna.letter=choice(Myna.letterLower,Myna.letterUpper);Myna.digit=range("0","9");Myna.digitNonZero=range("1","9");Myna.integer=choice("0",seq(Myna.digitNonZero,Myna.digit.star));Myna.hexDigit=choice(Myna.digit,range("a","f"),range("A","F"));Myna.binaryDigit=choice("0","1");Myna.octalDigit=range("0","7");Myna.alphaNumeric=choice(Myna.letter,Myna.digit);Myna.underscore=text("_");Myna.identifierFirst=choice(Myna.letter,Myna.underscore);Myna.identifierNext=choice(Myna.alphaNumeric,Myna.underscore);Myna.identifier=seq(Myna.identifierFirst,Myna.identifierNext.star);Myna.hyphen=text("-");Myna.crlf=text("\r\n");Myna.newLine=choice(Myna.crlf,"\n");Myna.space=text(" ");Myna.tab=text("\t");Myna.ws=char(" \t\r\n").star;function grammarRules(g){return Object.keys(g).map(function(k){return g[k]}).filter(function(v){return v instanceof Rule})}Myna.grammarRules=grammarRules;function grammarToString(g){return grammarRules(g).map(function(r){return r.toString()}).join("\n")}Myna.grammarToString=grammarToString;function registerGrammar(grammarName,grammar){for(var k in grammar){if(grammar[k]instanceof Rule){var ruleName=grammarName+"."+k;var rule=grammar[k];rule.setName(ruleName);Myna.rules[ruleName]=rule}}Myna.grammars[grammarName]=grammar}Myna.registerGrammar=registerGrammar;registerGrammar("core",Myna)})(Myna||(Myna={}));if(typeof module==="object"&&module.exports)module.exports.Myna=Myna;